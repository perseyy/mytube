# Объяснение проекта myYouTube

## Что это за проект?

Это веб-приложение - упрощенная версия YouTube. Пользователи могут:
- Регистрироваться и входить в систему
- Загружать видео (публичные или приватные)
- Просматривать видео
- Ставить лайки
- Оставлять комментарии

Проект написан на **Python** с использованием фреймворка **Flask** для веб-сервера.

---

## Структура проекта

```
mytube/
├── app.py              # Главный файл с логикой приложения
├── test_app.py         # Тесты для проверки работы функций
├── videos.db           # База данных SQLite (создается автоматически)
├── uploads/            # Папка для загруженных видео (создается автоматически)
└── templates/          # HTML шаблоны для страниц
    ├── base.html       # Базовый шаблон (общий для всех страниц)
    ├── home.html       # Главная страница со списком видео
    ├── upload.html     # Страница загрузки видео
    └── video.html      # Страница просмотра видео
```

---

## Как запустить проект?

1. Установить Python (если еще не установлен)
2. Установить Flask: `pip install flask`
3. Запустить: `python mytube/app.py`
4. Открыть в браузере: `http://localhost:5000`

---

## Детальное объяснение кода

### 1. Импорты и настройка (строки 1-13)

```python
from flask import Flask, request, render_template, send_from_directory, redirect, url_for, make_response
import sqlite3
import os
import uuid
import hashlib
import datetime
```

**Что это?**
- `Flask` - фреймворк для создания веб-приложений
- `sqlite3` - для работы с базой данных
- `os` - для работы с файловой системой (создание папок)
- `uuid` - для генерации уникальных ID
- `hashlib` - для хэширования паролей (безопасность)
- `datetime` - для работы с датами

**Почему так?**
- Flask - простой и популярный фреймворк для Python
- SQLite - легкая база данных, не требует отдельного сервера
- UUID - гарантирует уникальность ID (не будет конфликтов)
- Хэширование паролей - пароли не хранятся в открытом виде

---

### 2. База данных (строки 16-67)

#### Функция `get_db()` (строки 16-19)
```python
def get_db():
    conn = sqlite3.connect('videos.db')
    conn.row_factory = sqlite3.Row
    return conn
```

**Что делает?**
- Подключается к базе данных `videos.db`
- `row_factory = sqlite3.Row` - позволяет обращаться к данным как к словарю (например, `row['email']`)

**Почему так?**
- Удобнее работать с данными через имена колонок, а не индексы

#### Функция `init_db()` (строки 21-65)

**Что делает?**
Создает 5 таблиц в базе данных:

1. **users** - пользователи
   - `id` - уникальный идентификатор
   - `email` - email (уникальный)
   - `password_hash` - хэш пароля (не сам пароль!)
   - `reg_date` - дата регистрации

2. **videos** - видео
   - `id` - уникальный идентификатор
   - `title` - название
   - `description` - описание
   - `owner_id` - ID владельца (кто загрузил)
   - `filename` - имя файла на диске
   - `private` - приватное (1) или публичное (0)
   - `upload_date` - дата загрузки
   - `views` - количество просмотров

3. **likes** - лайки
   - `video_id` - ID видео
   - `user_id` - ID пользователя
   - PRIMARY KEY (video_id, user_id) - один пользователь может лайкнуть видео только один раз

4. **comments** - комментарии
   - `id` - уникальный идентификатор
   - `video_id` - ID видео
   - `user_id` - ID автора комментария
   - `text` - текст комментария
   - `date` - дата комментария

5. **sessions** - сессии (для авторизации)
   - `token` - токен сессии
   - `user_id` - ID пользователя

**Почему так?**
- Разделение на таблицы - правильная структура базы данных (нормализация)
- PRIMARY KEY - гарантирует уникальность и быстрый поиск
- Хранение токенов отдельно - для управления сессиями

---

### 3. Безопасность (строки 69-97)

#### Хэширование паролей (строки 69-71)
```python
def hash_password(pw):
    return hashlib.sha256(pw.encode()).hexdigest()
```

**Что делает?**
- Преобразует пароль в хэш (необратимое преобразование)
- Например: "password123" → "ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f"

**Почему так?**
- Пароли нельзя восстановить из хэша
- Даже если база данных будет украдена, пароли останутся защищенными
- При входе сравнивается хэш введенного пароля с хэшем в базе

#### Декоратор `login_required` (строки 73-89)

**Что делает?**
- Проверяет, авторизован ли пользователь
- Если нет токена в cookies → перенаправляет на страницу входа
- Если токен недействителен → перенаправляет на страницу входа
- Если все ОК → добавляет `user_id` в `request` и выполняет функцию

**Как используется?**
```python
@app.route('/upload', methods=['GET', 'POST'])
@login_required
def upload():
    # Эта функция выполнится только если пользователь авторизован
```

**Почему так?**
- Декоратор - удобный способ добавить проверку к любой функции
- Не нужно дублировать код проверки в каждой функции

#### Создание сессии (строки 91-97)
```python
def create_session(user_id):
    token = str(uuid.uuid4())
    # Сохраняет токен в базу данных
    return token
```

**Что делает?**
- Генерирует уникальный токен (например: "a1b2c3d4-e5f6-7890-abcd-ef1234567890")
- Сохраняет связь токен → user_id в базу данных
- Возвращает токен (он будет сохранен в cookies браузера)

**Почему так?**
- Токен - это "пропуск" пользователя
- Браузер автоматически отправляет cookies с каждым запросом
- Сервер проверяет токен и узнает, кто делает запрос

---

### 4. Маршруты (Routes) - страницы приложения

#### Главная страница `/` (строки 100-108)

**Что делает?**
1. Получает список публичных видео из базы (WHERE private = 0)
2. Сортирует по дате загрузки (новые первыми)
3. Проверяет, авторизован ли пользователь (есть ли токен в cookies)
4. Отображает страницу `home.html` с этим списком

**Почему так?**
- `ORDER BY upload_date DESC` - новые видео первыми
- `WHERE private = 0` - только публичные видео видны всем

---

#### Просмотр видео `/video/<video_id>` (строки 111-140)

**Что делает?**
1. Находит видео по ID в базе данных
2. Если видео приватное:
   - Проверяет, авторизован ли пользователь
   - Проверяет, является ли он владельцем
   - Если нет → ошибка 403 (доступ запрещен)
3. Увеличивает счетчик просмотров на 1
4. Подсчитывает количество лайков
5. Получает список комментариев
6. Отображает страницу `video.html`

**Почему так?**
- Приватные видео должны быть доступны только владельцу
- Счетчик просмотров обновляется при каждом просмотре
- Лайки и комментарии загружаются отдельными запросами к базе

---

#### Лайк `/like/<video_id>` (строки 143-163)

**Что делает?**
1. Проверяет авторизацию (есть ли токен)
2. Проверяет, лайкнул ли уже пользователь это видео
3. Если лайкнул → убирает лайк (DELETE)
4. Если не лайкнул → добавляет лайк (INSERT)
5. Возвращает новое количество лайков

**Почему так?**
- Переключение лайка (toggle) - можно и поставить, и убрать
- PRIMARY KEY в таблице likes предотвращает дубликаты
- Возвращает JSON (не HTML) - для обновления без перезагрузки страницы

---

#### Комментарий `/comment/<video_id>` (строки 165-185)

**Что делает?**
1. Проверяет авторизацию
2. Получает текст комментария из JSON запроса
3. Проверяет, что текст не пустой
4. Генерирует уникальный ID для комментария
5. Сохраняет комментарий в базу данных
6. Возвращает успешный ответ

**Почему так?**
- Только авторизованные пользователи могут комментировать
- UUID для ID комментария - гарантирует уникальность
- ISO формат даты - стандартный формат для хранения дат

---

#### Загрузка видео `/upload` (строки 188-214)

**Что делает?**
1. Если GET запрос → показывает форму загрузки
2. Если POST запрос:
   - Проверяет, что файл выбран
   - Генерирует уникальный ID для видео
   - Сохраняет файл на диск с именем `{video_id}_{оригинальное_имя}`
   - Получает название, описание, приватность из формы
   - Сохраняет информацию о видео в базу данных
   - Перенаправляет на главную страницу

**Почему так?**
- `@login_required` - только авторизованные могут загружать
- Уникальное имя файла предотвращает конфликты
- Сохранение метаданных в базу - для быстрого поиска и отображения

---

#### Регистрация `/register` (строки 225-240)

**Что делает?**
1. Получает email и пароль из JSON запроса
2. Проверяет, не существует ли уже пользователь с таким email
3. Если существует → ошибка 409 (конфликт)
4. Если нет:
   - Генерирует уникальный ID пользователя
   - Хэширует пароль
   - Сохраняет пользователя в базу данных
   - Создает сессию (токен)
   - Возвращает токен

**Почему так?**
- Проверка уникальности email - один email = один аккаунт
- Хэширование пароля - безопасность
- Автоматический вход после регистрации (создание сессии)

---

#### Вход `/login` (строки 242-254)

**Что делает?**
1. Получает email и пароль из JSON запроса
2. Ищет пользователя по email в базе данных
3. Хэширует введенный пароль и сравнивает с хэшем в базе
4. Если не совпадает → ошибка 401 (не авторизован)
5. Если совпадает:
   - Создает сессию (токен)
   - Возвращает токен

**Почему так?**
- Сравнение хэшей, а не паролей - пароли не хранятся
- Ошибка 401 - стандартный код для неверных учетных данных

---

#### Отдача файлов `/video_file/<filename>` и `/thumbnail/<filename>` (строки 217-223)

**Что делает?**
- Отдает файлы из папки `uploads/` браузеру
- Браузер может воспроизвести видео или показать изображение

**Почему так?**
- Безопасность - файлы отдаются через Flask, а не напрямую
- Можно добавить проверки доступа в будущем

---

## HTML шаблоны (templates)

### base.html
**Что это?**
- Базовый шаблон, от которого наследуются все остальные
- Содержит общие элементы: заголовок, навигацию, модальное окно входа
- Использует Bootstrap для стилизации

**Как работает наследование?**
```html
{% extends "base.html" %}
{% block content %}
    <!-- Содержимое страницы -->
{% endblock %}
```

### home.html
**Что это?**
- Главная страница со списком видео
- Показывает карточки видео с превью, названием, просмотрами, датой
- Если видео нет → показывает сообщение

### upload.html
**Что это?**
- Форма для загрузки видео
- Поля: название, описание, файл, чекбокс "приватное"
- Отправляет данные методом POST на `/upload`

### video.html
**Что это?**
- Страница просмотра видео
- Видеоплеер, описание, счетчик просмотров
- Кнопка лайка (обновляется через JavaScript)
- Форма комментариев (только для авторизованных)
- Список комментариев

---

## Тесты (test_app.py)

**Что это?**
- Автоматические проверки работы функций
- Проверяют регистрацию, вход, загрузку, лайки, комментарии

**Как запустить?**
```bash
python mytube/test_app.py
```

**Зачем?**
- Убедиться, что все работает правильно
- При изменении кода можно быстро проверить, ничего ли не сломалось

---

## Потенциальные вопросы и ответы

### Вопрос: Что такое Flask?
**Ответ:** Flask - это веб-фреймворк для Python. Он упрощает создание веб-приложений, обрабатывает HTTP запросы, маршрутизацию, работу с шаблонами.

### Вопрос: Что такое SQLite?
**Ответ:** SQLite - это легковесная база данных, которая хранится в одном файле. Не требует отдельного сервера, идеально для небольших проектов.

### Вопрос: Что такое декоратор?
**Ответ:** Декоратор - это функция, которая оборачивает другую функцию. `@login_required` автоматически проверяет авторизацию перед выполнением функции.

### Вопрос: Почему пароли хэшируются?
**Ответ:** Для безопасности. Если база данных будет украдена, злоумышленник не сможет узнать пароли пользователей, так как хэш нельзя обратить в исходный пароль.

### Вопрос: Что такое токен сессии?
**Ответ:** Токен - это уникальная строка, которая идентифицирует пользователя. Хранится в cookies браузера и отправляется с каждым запросом. Сервер проверяет токен и узнает, кто делает запрос.

### Вопрос: Что такое PRIMARY KEY?
**Ответ:** PRIMARY KEY - это уникальный идентификатор записи в таблице. Гарантирует, что не будет двух записей с одинаковым ID. Также ускоряет поиск.

### Вопрос: Что такое UUID?
**Ответ:** UUID (Universally Unique Identifier) - это способ генерации уникальных ID. Вероятность совпадения практически нулевая, даже при генерации миллионов ID.

### Вопрос: Что такое JSON?
**Ответ:** JSON - это формат данных для обмена информацией между клиентом и сервером. Похож на словарь Python, но в текстовом виде.

### Вопрос: Что такое cookies?
**Ответ:** Cookies - это небольшие данные, которые сервер сохраняет в браузере пользователя. Браузер автоматически отправляет их с каждым запросом. Используются для хранения токена авторизации.

### Вопрос: Что такое HTTP методы GET и POST?
**Ответ:** 
- GET - для получения данных (например, показать страницу)
- POST - для отправки данных (например, загрузить файл, отправить форму)

### Вопрос: Что такое HTTP коды ответов?
**Ответ:**
- 200 - успешно
- 302 - перенаправление
- 400 - неверный запрос
- 401 - не авторизован
- 403 - доступ запрещен
- 404 - не найдено
- 409 - конфликт (например, пользователь уже существует)

### Вопрос: Как работает авторизация в этом проекте?
**Ответ:**
1. Пользователь вводит email и пароль
2. Сервер проверяет данные в базе
3. Если верно - создается токен и сохраняется в базу данных
4. Токен отправляется клиенту и сохраняется в cookies
5. При каждом запросе браузер отправляет токен
6. Сервер проверяет токен и узнает пользователя

### Вопрос: Как работает загрузка видео?
**Ответ:**
1. Пользователь выбирает файл и заполняет форму
2. Файл отправляется на сервер методом POST
3. Сервер генерирует уникальное имя файла
4. Файл сохраняется в папку `uploads/`
5. Информация о видео (название, описание, имя файла) сохраняется в базу данных
6. Пользователь перенаправляется на главную страницу

### Вопрос: Как работает система лайков?
**Ответ:**
1. Пользователь нажимает кнопку лайка
2. JavaScript отправляет POST запрос на `/like/<video_id>`
3. Сервер проверяет, есть ли уже лайк от этого пользователя
4. Если есть - удаляет, если нет - добавляет
5. Подсчитывает общее количество лайков
6. Возвращает новое количество в JSON
7. JavaScript обновляет страницу

### Вопрос: Почему используется `row_factory = sqlite3.Row`?
**Ответ:** Это позволяет обращаться к данным по именам колонок (`row['email']`) вместо индексов (`row[0]`). Код становится более читаемым и понятным.

### Вопрос: Что такое `with get_db() as db:`?
**Ответ:** Это контекстный менеджер. Автоматически закрывает соединение с базой данных после выполнения блока кода, даже если произошла ошибка. Это правильный способ работы с базой данных.

### Вопрос: Что такое `request.cookies.get('token')`?
**Ответ:** Получает значение cookie с именем 'token' из запроса. Если cookie нет, вернется `None`.

### Вопрос: Что такое `request.user_id`?
**Ответ:** Это кастомное поле, которое добавляется декоратором `login_required`. После проверки авторизации в `request.user_id` сохраняется ID пользователя, чтобы функция знала, кто делает запрос.

### Вопрос: Что такое `render_template`?
**Ответ:** Функция Flask, которая берет HTML шаблон, подставляет в него данные и возвращает готовую HTML страницу браузеру.

### Вопрос: Что такое `redirect`?
**Ответ:** Перенаправляет пользователя на другую страницу. Например, после загрузки видео перенаправляет на главную страницу.

### Вопрос: Что такое `send_from_directory`?
**Ответ:** Безопасно отдает файлы из указанной папки. Проверяет, что файл действительно в этой папке, предотвращая доступ к файлам вне папки.

### Вопрос: Почему используется `os.makedirs(UPLOAD_FOLDER, exist_ok=True)`?
**Ответ:** Создает папку для загрузок, если её еще нет. `exist_ok=True` означает, что не будет ошибки, если папка уже существует.

### Вопрос: Что такое `app.config['UPLOAD_FOLDER']`?
**Ответ:** Это способ хранения настроек приложения. В данном случае хранится путь к папке для загрузок. Можно обращаться к нему из любой части приложения.

### Вопрос: Что такое `app.secret_key`?
**Ответ:** Секретный ключ Flask для подписи cookies и сессий. В реальном проекте должен быть сложным и храниться в переменных окружения.

### Вопрос: Что такое `if __name__ == '__main__':`?
**Ответ:** Код внутри этого блока выполняется только при прямом запуске файла, а не при импорте. Это стандартная практика в Python.

### Вопрос: Что такое `debug=True`?
**Ответ:** Включает режим отладки Flask. При ошибках показывает подробную информацию. В продакшене должно быть `False`.

---

## Основные концепции для понимания

### 1. Клиент-серверная архитектура
- **Клиент** (браузер) отправляет запросы
- **Сервер** (Flask приложение) обрабатывает запросы и отправляет ответы

### 2. HTTP запросы
- Браузер отправляет HTTP запросы (GET, POST)
- Сервер обрабатывает их и возвращает ответ (HTML, JSON, файлы)

### 3. База данных
- Хранит структурированные данные (пользователи, видео, комментарии)
- SQLite - файловая база данных, не требует отдельного сервера

### 4. Шаблонизация
- HTML шаблоны с переменными
- Flask подставляет данные в шаблоны

### 5. Сессии и авторизация
- Токен в cookies идентифицирует пользователя
- Сервер проверяет токен при каждом запросе

---

## Что можно улучшить в будущем?

1. **Безопасность:**
   - Использовать более сложное хэширование (bcrypt вместо SHA256)
   - Хранить secret_key в переменных окружения
   - Добавить защиту от CSRF атак

2. **Функциональность:**
   - Поиск видео
   - Категории/теги
   - Подписки на каналы
   - Плейлисты
   - Генерация превью для видео

3. **Производительность:**
   - Кэширование
   - Пагинация (разбиение на страницы)
   - Оптимизация запросов к базе данных

4. **UX/UI:**
   - Более красивый дизайн
   - Адаптивность для мобильных устройств
   - Загрузка комментариев без перезагрузки страницы

---

## Заключение

Это полнофункциональное веб-приложение, демонстрирующее:
- Работу с веб-фреймворком Flask
- Работу с базой данных SQLite
- Систему авторизации через токены
- Загрузку и отдачу файлов
- Взаимодействие клиента и сервера через HTTP
- Использование HTML шаблонов

Проект готов к демонстрации и объяснению основных концепций веб-разработки.

